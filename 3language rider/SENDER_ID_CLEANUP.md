# Очистка ID отправителей и инструменты экспорта

## Обновления

### 1. Очистка sender_id
- **Удалены ведущие нули**: Все sender_id теперь очищаются от ведущих нулей
- **Замена нуля**: sender_id = 0 заменяется на "1" для корректного отображения
- **ID бота**: Большие ID (начинающиеся с "100" или длиной > 10 символов) заменяются на "bot"
- **Примеры**:
  - `00123` → `123`
  - `0456` → `456`
  - `0` → `1`
  - `1002787335121` → `bot`

### 2. Улучшенный экспорт
- **Форматы**: CSV и JSON
- **Выпадающее меню**: Выбор формата экспорта
- **Сохранение фильтров**: Экспортируются только отфильтрованные данные
- **Имена файлов**: Автоматическая генерация с датой и временем

### 3. Тестирование
- **API endpoint**: `/api/test-history-cleanup` для создания тестовых данных
- **Различные сценарии**: Тестовые сообщения с разными sender_id
- **Проверка обработки**: Подтверждение корректной обработки ID

## Использование

### Просмотр истории
1. Перейдите на страницу `/history`
2. Используйте фильтры для отбора сообщений
3. Отправители теперь отображаются как:
   - "Bot" для сообщений от бота
   - "Пользователь X" для обычных пользователей

### Экспорт данных
1. Настройте фильтры по необходимости
2. Нажмите кнопку "Экспорт"
3. Выберите формат:
   - **CSV**: для Excel/Google Sheets
   - **JSON**: для программной обработки

### Тестовые данные
Для создания тестовых данных выполните:
```bash
curl -X POST http://localhost:3000/api/test-history-cleanup \
  -H "Content-Type: application/json" \
  -H "Cookie: session-token=your-token"
```

## Технические детали

### Обработка sender_id
```javascript
let processedSenderId = msg.sender_id.toString();
// Убираем ведущие нули, но оставляем хотя бы одну цифру
processedSenderId = processedSenderId.replace(/^0+/, '') || '0';
// Заменяем 0 на 1 для корректного отображения
if (processedSenderId === '0') {
  processedSenderId = '1';
}
// Если sender_id соответствует ID бота
if (msg.sender_id === msg.bot_id || processedSenderId.startsWith('100') || processedSenderId.length > 10) {
  processedSenderId = 'bot';
}
```

### Форматы экспорта
- **CSV**: таблица с заголовками
- **JSON**: структурированные данные с метаданными

Все изменения сохраняют обратную совместимость и улучшают пользовательский опыт.